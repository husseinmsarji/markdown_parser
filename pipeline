# tools/get_refresh_token_once.py (run locally)
import os, json, webbrowser
from http.server import HTTPServer, BaseHTTPRequestHandler
from urllib.parse import urlparse, parse_qs
from google_auth_oauthlib.flow import Flow

PORT = 8080
REDIRECT_URI = f"http://localhost:{PORT}/oauth2callback"
SCOPES = [
  "https://www.googleapis.com/auth/drive.readonly",
  "https://www.googleapis.com/auth/spreadsheets.readonly",
]

# Create a OAuth client in Cloud Console and place the JSON here or load from env/secret
CLIENT_ID = "<YOUR_CLIENT_ID>"
CLIENT_SECRET = "<YOUR_CLIENT_SECRET>"

flow = Flow.from_client_config({
  "installed": {
    "client_id": CLIENT_ID,
    "client_secret": CLIENT_SECRET,
    "redirect_uris": [REDIRECT_URI],
    "auth_uri": "https://accounts.google.com/o/oauth2/auth",
    "token_uri": "https://oauth2.googleapis.com/token"
  }
}, scopes=SCOPES, redirect_uri=REDIRECT_URI)

auth_url, _ = flow.authorization_url(access_type="offline", include_granted_scopes="true", prompt="consent")

class Handler(BaseHTTPRequestHandler):
    def do_GET(self):
        q = parse_qs(urlparse(self.path).query)
        if self.path.startswith("/oauth2callback") and "code" in q:
            flow.fetch_token(code=q["code"][0])
            creds = flow.credentials
            print("\nREFRESH TOKEN:", creds.refresh_token, "\n")
            self.send_response(200)
            self.end_headers()
            self.wfile.write(b"You may close this tab.")
        else:
            self.send_response(404); self.end_headers()

print("Open:", auth_url)
webbrowser.open(auth_url)

HTTPServer(("localhost", PORT), Handler).serve_forever()
